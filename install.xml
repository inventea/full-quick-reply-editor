<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<?xml-stylesheet type="text/xsl" href="modx.prosilver.en.xsl"?>
<!-- For security purposes, please check: http://www.phpbb.com/mods/ for the latest version of this MOD. Although MODs are checked before being allowed in the MODs Database there is no guarantee that there are no security problems within the MOD. No support will be given for MODs not found within the MODs Database which can be found at http://www.phpbb.com/mods/ -->
<mod xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.phpbb.com/mods/xml/modx-1.2.5.xsd">
	<header>
		<license><![CDATA[http://opensource.org/licenses/gpl-license.php GNU General Public License v2]]></license>
		
		<title lang="en"><![CDATA[Full Quick Reply Editor]]></title>
		<title lang="pl"><![CDATA[Full Quick Reply Editor]]></title>
		
		<description lang="en"><![CDATA[Expands quick reply by default and transforms basic editor into full version with post icons, emoticons and BBCode buttons. Adds selective quoting option available through default button.]]></description>
		<description lang="pl"><![CDATA[Rozwija domyślnie szybką odpowiedź oraz rozszerza funkcje podstawowego edytora o ikony posta, emotikony i znaczniki BBCode. Dodaje opcję cytowania selektywnego dostępną pod domyślnym przyciskiem.]]></description>
		
		<author-notes lang="en"><![CDATA[Works only with phpBB 3.0.6 and above! Premoded files in contrib/ directory.]]></author-notes>
		<author-notes lang="pl"><![CDATA[Działa wyłącznie na phpBB 3.0.6 i nowszym! Zmodyfikowane pliki w katalogu contrib/.]]></author-notes>
		
		<author-group>
			<author>
				<realname><![CDATA[Jarosław Pustuła]]></realname>
				<username><![CDATA[medeish]]></username>
				<homepage><![CDATA[http://inventia.io]]></homepage>
				<email><![CDATA[office@inventia.io]]></email>
				<contributions-group>
					<contributions status="current" from="2009-11-26" position="Developer"></contributions>
				</contributions-group>
			</author>
		</author-group>
		
		<mod-version>2.0.1</mod-version>
		
		<installation>
			<level>easy</level>
			<time>300</time>
			<target-version>3.0.7-PL1</target-version>
		</installation>
		
		<history>
			<entry>
				<date>2009-11-26</date>
				<rev-version>1.0.0</rev-version>
				<changelog lang="en">
					<change><![CDATA[Initial release]]></change>
				</changelog>
				<changelog lang="pl">
					<change><![CDATA[Pierwsze wydanie]]></change>
				</changelog>
			</entry>
			<entry>
				<date>2009-12-24</date>
				<rev-version>1.0.1</rev-version>
				<changelog lang="en">
					<change><![CDATA[Fixed undefined variable notice in debug mode]]></change>
				</changelog>
				<changelog lang="pl">
					<change><![CDATA[Poprawiono komunikat o niezdefiniowanej zmiennej]]></change>
				</changelog>
			</entry>
			<entry>
				<date>2010-03-28</date>
				<rev-version>2.0.0</rev-version>
				<changelog lang="en">
					<change><![CDATA[Quick reply is expanded by default]]></change>
					<change><![CDATA[Added selective quoting based on phpBB's feature]]></change>
					<change><![CDATA[Added button to save post draft]]></change>
					<change><![CDATA[Adjusted to phpBB 3.0.7]]></change>
					<change><![CDATA[Updated MODX to version 1.2.5]]></change>
				</changelog>
				<changelog lang="pl">
					<change><![CDATA[Szybka odpowiedź jest domyślnie rozwinięta]]></change>
					<change><![CDATA[Dodano cytowanie selektywne oparte na wbudowanych funkcjach]]></change>
					<change><![CDATA[Dodano przycisk do zapisywania szkicu posta]]></change>
					<change><![CDATA[Przystosowano do phpBB 3.0.7]]></change>
					<change><![CDATA[Zaktualizowano MODX do wersji 1.2.5]]></change>
				</changelog>
			</entry>
			<entry>
				<date>2010-05-04</date>
				<rev-version>2.0.1</rev-version>
				<changelog lang="en">
					<change><![CDATA[Updated modification instruction to work with newest AutoMOD]]></change>
					<change><![CDATA[Changed $user->setup() method to $user->add_lang() in viewtopic.php]]></change>
				</changelog>
				<changelog lang="pl">
					<change><![CDATA[Przystosowano instrukcję modyfikacji dla najnowszego AutoMOD–a]]></change>
					<change><![CDATA[Zmieniono metodę $user->setup() na $user->add_lang() w pliku viewtopic.php]]></change>
				</changelog>
			</entry>
		</history>
		
		<link-group>
			<link type="template" href="templates/subsilver2.xml" lang="en">subsilver2</link>
		</link-group>
	</header>
	
	<action-group>
		<open src="styles/prosilver/template/quickreply_editor.html">
			<edit>
				<remove><![CDATA[<script type="text/javascript">
// <![CDATA[
	function hide_qr(show)
	{
		dE('qr_editor_div');
		dE('qr_showeditor_div');
		if (show && document.getElementById('qr_editor_div').style.display != 'none')
		{
			document.getElementsByName('message')[0].focus();
		}
		return true;
	}


	function init_qr()
	{
		dE('qr_showeditor_div');
		return true;
	}
	onload_functions.push('init_qr();');
	// ]]]]><![CDATA[>
</script>
<noscript>
	<form method="post" action="{U_QR_ACTION}">
		<div class="panel" id="qr_ns_editor_div">
			<div class="inner"><span class="corners-top"><span></span></span>
					<h2>{L_QUICKREPLY}</h2>
					<fieldset class="fields1">
						<dl style="clear: left;">
							<dt><label for="subject">{L_SUBJECT}:</label></dt>
							<dd><input type="text" name="subject" id="subject-ns" size="45" maxlength="64" tabindex="2" value="{SUBJECT}" class="inputbox autowidth" /></dd>
						</dl>
					<div id="message-box-ns">
						<textarea style="height: 9em;" name="message" rows="7" cols="76" tabindex="3" class="inputbox"></textarea>
					</div>
					</fieldset>
					<fieldset class="submit-buttons">
						{S_FORM_TOKEN}
						{QR_HIDDEN_FIELDS}
						<input type="submit" accesskey="s" tabindex="6" name="post" value="{L_SUBMIT}" class="button1" />&nbsp;
						<input type="submit" accesskey="f" tabindex="7" name="full_editor" value="{L_FULL_EDITOR}" class="button2" />&nbsp;
					</fieldset>
			<span class="corners-bottom"><span></span></span></div>
		</div>
	</form>
</noscript>]]></remove>
			</edit>
			<edit>
				<find><![CDATA[<form method="post" action="{U_QR_ACTION}">
	<div class="panel" style="display: none" id="qr_editor_div">
		<div class="inner"><span class="corners-top"><span></span></span>
				<h2>{L_QUICKREPLY}</h2>
				<fieldset class="fields1">
					<dl style="clear: left;">
						<dt><label for="subject">{L_SUBJECT}:</label></dt>
						<dd><input type="text" name="subject" id="subject" size="45" maxlength="64" tabindex="2" value="{SUBJECT}" class="inputbox autowidth" /></dd>
					</dl>
				<div id="message-box">
					<textarea style="height: 9em;" name="message" rows="7" cols="76" tabindex="3" class="inputbox"></textarea>
				</div>
				</fieldset>
				<fieldset class="submit-buttons">
					{S_FORM_TOKEN}
					{QR_HIDDEN_FIELDS}
					<input type="submit" accesskey="s" tabindex="6" name="post" value="{L_SUBMIT}" class="button1" />&nbsp;
					<input type="submit" accesskey="f" tabindex="6" name="full_editor" value="{L_FULL_EDITOR}" class="button2" />&nbsp;
				</fieldset>
				<a href="" class="right-box up" onclick="hide_qr(false); return false;" title="{L_COLLAPSE_QR}">{L_COLLAPSE_QR}</a>
		<span class="corners-bottom"><span></span></span></div>
	</div>
	<div class="panel" style="display: none" id="qr_showeditor_div" >
		<div class="inner"><span class="corners-top"><span></span></span>

			<div class="content">
				<fieldset class="submit-buttons">
					<input type="submit" name="show_qr" tabindex="1" class="button2" value="{L_SHOW_QR}" onclick="hide_qr(true);return false;"/>
				</fieldset>
			</div>
		<span class="corners-bottom"><span></span></span></div>
	</div>
</form>]]></find>
				<action type="replace-with"><![CDATA[<form id="postform" method="post" action="{U_QR_ACTION}">
	<div class="panel" id="postingbox">
		<div class="inner"><span class="corners-top"><span></span></span>
		
		<h2>{L_QUICKREPLY}</h2>
		
		<fieldset class="fields1">
			<!-- IF S_SHOW_TOPIC_ICONS -->
			<dl>
				<dt><label for="icon">{L_ICON}:</label></dt>
				<dd>
					<label for="icon"><input type="radio" name="icon" id="icon" value="0" checked="checked" /> {L_NO_TOPIC_ICON}</label>
					<!-- BEGIN topic_icon --><label for="icon-{topic_icon.ICON_ID}"><input type="radio" name="icon" id="icon-{topic_icon.ICON_ID}" value="{topic_icon.ICON_ID}" {topic_icon.S_ICON_CHECKED} /><img src="{topic_icon.ICON_IMG}" width="{topic_icon.ICON_WIDTH}" height="{topic_icon.ICON_HEIGHT}" alt="" title="" /></label> <!-- END topic_icon -->
				</dd>
			</dl>
			<!-- ENDIF -->

			<dl style="clear: left;">
				<dt><label for="subject">{L_SUBJECT}:</label></dt>
				<dd><input type="text" name="subject" id="subject" size="45" maxlength="64" tabindex="2" value="{SUBJECT}" class="inputbox autowidth" /></dd>
			</dl>
			
			<!-- INCLUDE posting_buttons.html -->
			
			<div id="smiley-box">
				<!-- IF S_SMILIES_ALLOWED and .smiley -->
					<strong>{L_SMILIES}</strong><br />
					<!-- BEGIN smiley -->
						<a href="#" onclick="insert_text('{smiley.A_SMILEY_CODE}', true); return false;"><img src="{smiley.SMILEY_IMG}" width="{smiley.SMILEY_WIDTH}" height="{smiley.SMILEY_HEIGHT}" alt="{smiley.SMILEY_CODE}" title="{smiley.SMILEY_DESC}" /></a>
					<!-- END smiley -->
				<!-- ENDIF -->
				<!-- IF S_SHOW_SMILEY_LINK and S_SMILIES_ALLOWED-->
					<br /><a href="{U_MORE_SMILIES}" onclick="popup(this.href, 300, 350, '_phpbbsmilies'); return false;">{L_MORE_SMILIES}</a>
				<!-- ENDIF -->

				<!-- IF BBCODE_STATUS -->
				<!-- IF .smiley --><hr /><!-- ENDIF -->
				{BBCODE_STATUS}<br />
				<!-- IF S_BBCODE_ALLOWED -->
					{IMG_STATUS}<br />
					{FLASH_STATUS}<br />
					{URL_STATUS}<br />
				<!-- ENDIF -->
				{SMILIES_STATUS}
				<!-- ENDIF -->
			</div>

			<div id="message-box">
				<textarea style="height: 11em;" name="message" rows="7" cols="76" tabindex="3" class="inputbox"></textarea>
			</div>
		</fieldset>
		
		<span class="corners-bottom"><span></span></span></div>
	</div>
	
	<div class="panel bg2">
		<div class="inner"><span class="corners-top"><span></span></span>
			<fieldset class="submit-buttons">
				{S_FORM_TOKEN}
				{QR_HIDDEN_FIELDS}
				<!-- IF S_SAVE_ALLOWED --><input type="submit" accesskey="k" tabindex="7" name="save" value="{L_SAVE}" class="button2" />&nbsp; <!-- ENDIF -->
				<input type="submit" tabindex="6" name="preview" value="{L_PREVIEW}" class="button1" onclick="document.getElementById('postform').action += '#preview';" />&nbsp;
				<input type="submit" accesskey="s" tabindex="6" name="post" value="{L_SUBMIT}" class="button1" />&nbsp;
			</fieldset>
		<span class="corners-bottom"><span></span></span></div>
	</div>
</form>]]></action>
			</edit>
		</open>

		<open src="styles/prosilver/template/viewtopic_body.html">
			<edit>
				<find><![CDATA[					<!-- IF postrow.U_QUOTE --><li class="quote-icon"><a href="{postrow.U_QUOTE}" title="{L_REPLY_WITH_QUOTE}"><span>{L_REPLY_WITH_QUOTE}</span></a></li><!-- ENDIF -->]]></find>
				<action type="replace-with"><![CDATA[					<!-- IF S_QUICK_REPLY and postrow.DECODED_MESSAGE --><li class="quote-icon"><a href="#postingbox" onclick="addquote({postrow.POST_ID}, '{postrow.POST_AUTHOR}');" title="{L_QUOTE} {postrow.POST_AUTHOR}"><span>{L_QUOTE} {postrow.POST_AUTHOR}</span></a></li><!-- ELSE IF postrow.U_QUOTE --><li class="quote-icon"><a href="{postrow.U_QUOTE}" title="{L_REPLY_WITH_QUOTE}"><span>{L_REPLY_WITH_QUOTE}</span></a></li><!-- ENDIF -->]]></action>
			</edit>
			<edit>
				<find><![CDATA[			<div class="content">{postrow.MESSAGE}</div>]]></find>
				<action type="after-add"><![CDATA[			<!-- IF postrow.U_QUOTE and postrow.DECODED_MESSAGE -->
				<div id="message_{postrow.POST_ID}" style="display: none;">{postrow.DECODED_MESSAGE}</div>
			<!-- ENDIF -->]]></action>
			</edit>
		</open>
		
		<open src="viewtopic.php">
			<edit>
				<find><![CDATA[include($phpbb_root_path . 'includes/functions_display.' . $phpEx);]]></find>
				<action type="after-add"><![CDATA[include($phpbb_root_path . 'includes/functions_posting.' . $phpEx);]]></action>
			</edit>
			<edit>
				<find><![CDATA[// Output the posts
$first_unread = $post_unread = false;]]></find>
				<action type="before-add"><![CDATA[// Check whether quick reply is enabled
$s_quick_reply = false;
if ($user->data['is_registered'] && $config['allow_quick_reply'] && ($topic_data['forum_flags'] & FORUM_FLAG_QUICK_REPLY) && $auth->acl_get('f_reply', $forum_id))
{
	// Quick reply enabled forum
	$s_quick_reply = (($topic_data['forum_status'] == ITEM_UNLOCKED && $topic_data['topic_status'] == ITEM_UNLOCKED) || $auth->acl_get('m_edit', $forum_id)) ? true : false;
}]]></action>
			</edit>
			<edit>
				<find><![CDATA[	// Parse the message and subject
	$message = censor_text($row['post_text']);]]></find>
				<action type="after-add"><![CDATA[	$decoded_message = false;

	if ($s_quick_reply)
	{
		$decoded_message = $message;
		decode_message($decoded_message, $row['bbcode_uid']);

		$decoded_message = bbcode_nl2br($decoded_message);
	}]]></action>
			</edit>
			<edit>
				<find><![CDATA[		'MESSAGE'			=> $message,]]></find>
				<action type="after-add"><![CDATA[		'DECODED_MESSAGE'   => $decoded_message,]]></action>
			</edit>
			<edit>
				<comment lang="en"><![CDATA[Around line 1687.]]></comment>
				<comment lang="pl"><![CDATA[Około linii 1687.]]></comment>
				<remove><![CDATA[// let's set up quick_reply
$s_quick_reply = false;
if ($user->data['is_registered'] && $config['allow_quick_reply'] && ($topic_data['forum_flags'] & FORUM_FLAG_QUICK_REPLY) && $auth->acl_get('f_reply', $forum_id))
{
	// Quick reply enabled forum
	$s_quick_reply = (($topic_data['forum_status'] == ITEM_UNLOCKED && $topic_data['topic_status'] == ITEM_UNLOCKED) || $auth->acl_get('m_edit', $forum_id)) ? true : false;
}]]></remove>
			</edit>
			<edit>
				<find><![CDATA[		$s_attach_sig	= $config['allow_sig'] && $user->optionget('attachsig') && $auth->acl_get('f_sigs', $forum_id) && $auth->acl_get('u_sig');
		$s_smilies		= $config['allow_smilies'] && $user->optionget('smilies') && $auth->acl_get('f_smilies', $forum_id);
		$s_bbcode		= $config['allow_bbcode'] && $user->optionget('bbcode') && $auth->acl_get('f_bbcode', $forum_id);
		$s_notify		= $config['allow_topic_notify'] && ($user->data['user_notify'] || $s_watching_topic['is_watching']);]]></find>
				<action type="before-add"><![CDATA[		$user->add_lang(array('posting', 'mcp'));]]></action>
				<action type="after-add"><![CDATA[		$s_url			= $config['allow_post_links'];
		$s_img			= $s_bbcode && $auth->acl_get('f_img', $forum_id);
		$s_flash		= $s_bbcode && $auth->acl_get('f_flash', $forum_id) && $config['allow_post_flash'];
		$s_topic_icons	= false;

		if ($topic_data['enable_icons'] && $auth->acl_get('f_icons', $forum_id))
		{
			$s_topic_icons = posting_gen_topic_icons('reply', $topic_data['icon_id']);
		}]]></action>
			</edit>
			<edit>
				<find><![CDATA[		$template->assign_vars(array(
			'S_QUICK_REPLY'			=> true,
			'U_QR_ACTION'			=> append_sid("{$phpbb_root_path}posting.$phpEx", "mode=reply&amp;f=$forum_id&amp;t=$topic_id"),
			'QR_HIDDEN_FIELDS'		=> build_hidden_fields($qr_hidden_fields),
			'SUBJECT'				=> 'Re: ' . censor_text($topic_data['topic_title']),
		));]]></find>
				<action type="replace-with"><![CDATA[		$template->assign_vars(array(
			'L_ICON'					=> $user->lang['POST_ICON'],
			'L_MESSAGE_BODY_EXPLAIN'	=> (intval($config['max_post_chars'])) ? sprintf($user->lang['MESSAGE_BODY_EXPLAIN'], intval($config['max_post_chars'])) : '',

			'SUBJECT'				=> 'Re: ' . censor_text($topic_data['topic_title']),
			'BBCODE_STATUS'			=> ($s_bbcode) ? sprintf($user->lang['BBCODE_IS_ON'], '<a href="' . append_sid("{$phpbb_root_path}faq.$phpEx", 'mode=bbcode') . '">', '</a>') : sprintf($user->lang['BBCODE_IS_OFF'], '<a href="' . append_sid("{$phpbb_root_path}faq.$phpEx", 'mode=bbcode') . '">', '</a>'),
			'IMG_STATUS'			=> ($s_img) ? $user->lang['IMAGES_ARE_ON'] : $user->lang['IMAGES_ARE_OFF'],
			'FLASH_STATUS'			=> ($s_flash) ? $user->lang['FLASH_IS_ON'] : $user->lang['FLASH_IS_OFF'],
			'SMILIES_STATUS'		=> ($s_smilies) ? $user->lang['SMILIES_ARE_ON'] : $user->lang['SMILIES_ARE_OFF'],
			'URL_STATUS'			=> ($s_bbcode && $s_url) ? $user->lang['URL_IS_ON'] : $user->lang['URL_IS_OFF'],
			'U_QR_ACTION'			=> append_sid("{$phpbb_root_path}posting.$phpEx", "mode=reply&amp;f=$forum_id&amp;t=$topic_id"),
			'QR_HIDDEN_FIELDS'		=> build_hidden_fields($qr_hidden_fields),

			'S_QUICK_REPLY'			=> true,
			'S_SHOW_TOPIC_ICONS'	=> $s_topic_icons,
			'S_BBCODE_ALLOWED'		=> $s_bbcode,
			'S_SMILIES_ALLOWED'		=> $s_smilies,
			'S_LINKS_ALLOWED'		=> $s_url,
			'S_SAVE_ALLOWED'		=> ($auth->acl_get('u_savedrafts') && $user->data['is_registered']) ? true : false,
			
			'S_BBCODE_IMG'			=> $s_img,
			'S_BBCODE_URL'			=> $s_url,
			'S_BBCODE_FLASH'		=> $s_flash,
			'S_BBCODE_QUOTE'		=> true,
		));

		// Build custom bbcodes array
		display_custom_bbcodes();

		// Generate smiley listing
		generate_smilies('inline', $forum_id);]]></action>
			</edit>
		</open>
		
		<diy-instructions lang="en"><![CDATA[Purge the forum cache and refresh style templates.]]></diy-instructions>
		<diy-instructions lang="pl"><![CDATA[Wyczyść pamięć podręczną forum oraz odśwież szablony stylu.]]></diy-instructions>
	</action-group>
</mod>